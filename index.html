<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>教室預約（最小可用版）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:16px;line-height:1.5;color:#111}
  h1{margin:0 0 12px}
  .bar{background:#f6f7f9;border:1px solid #e5e7eb;padding:10px 12px;border-radius:8px;margin-bottom:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
  label{display:block;font-size:14px;color:#374151}
  input,select,button{padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
  button{cursor:pointer;background:#111;color:#fff;border-color:#111}
  button.secondary{background:#fff;color:#111}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-top:12px}
  .slot{border:1px solid #cbd5e1;border-radius:8px;padding:10px;background:#fff}
  .slot.booked{background:#f3f4f6;color:#6b7280}
  .panel{border:1px solid #e5e7eb;border-radius:8px;padding:12px;margin-top:12px}
  .panel h3{margin:0 0 8px}
  .hint{font-size:12px;color:#6b7280}
  .ok{color:#16a34a}.err{color:#dc2626}
  .two{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  @media(max-width:900px){.two{grid-template-columns:1fr}}
</style>
</head>
<body>
  <h1>教室預約（最小可用版）</h1>

  <div class="bar" id="diag">診斷：初始化中…</div>

  <div class="two">
    <div>
      <div class="panel">
        <h3>步驟 1：選日期與教室</h3>
        <div class="row">
          <div>
            <label>日期（週一至週五）</label>
            <input id="dateInput" type="date">
            <div id="dateHint" class="hint"></div>
          </div>
          <div>
            <label>教室</label>
            <select id="roomSelect">
              <option value="R1">小水槽</option>
              <option value="R2">B1-12（工具間）</option>
              <option value="R3">406-2（流力實驗室）</option>
            </select>
          </div>
          <div>
            <button id="loadBtn">載入時段</button>
          </div>
        </div>
        <div id="slotsWrap" class="panel" style="display:none">
          <h3 id="slotsTitle">可預約時段</h3>
          <div class="grid" id="slotsGrid"></div>
          <div class="hint" style="margin-top:8px">白色＝可預約；灰色＝已預約。點灰色可取消（需學號＋電話）。</div>
        </div>
      </div>
    </div>

    <div>
      <div class="panel" id="formPanel" style="display:none">
        <h3 id="formTitle">預約表單</h3>
        <div id="formBody"></div>
        <div id="formMsg" class="hint"></div>
      </div>
    </div>
  </div>

<script>
/** ===== 設定 =====
 * 若你已部署 Apps Script，將下列 URL 改成 /exec 網址。
 * 沒改的話，就用「本機儲存」模式，你仍可完整測試預約/取消流程。
 */
const GAS_BASE = 'REPLACE_ME_WITH_YOUR_EXEC_URL';

/** ===== 小工具 ===== */
const $ = (s)=>document.querySelector(s);
const pad2 = (n)=>String(n).padStart(2,'0');
const HOURS = Array.from({length:13},(_,i)=>9+i); // 9..21
function isWeekday(dateStr){ const d=new Date(dateStr+'T00:00:00'); const w=d.getDay(); return w>=1 && w<=5; }
function todayISO(){ const t=new Date(); return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`; }
function bookingKey(date,room,hour){ return `${date}__${room}__${hour}`; }

/** ===== 後端存取（GAS or 本機） ===== */
const isGAS = GAS_BASE && GAS_BASE !== 'REPLACE_ME_WITH_YOUR_EXEC_URL';
function loadFromLS(){ try{return JSON.parse(localStorage.getItem('room_bookings_v1')||'{}')}catch{return{}} }
function saveToLS(v){ localStorage.setItem('room_bookings_v1', JSON.stringify(v)); }

async function fetchBookings(date, room){
  if (!isGAS){ return loadFromLS(); }
  const url = `${GAS_BASE}?action=list&date=${encodeURIComponent(date)}&room=${encodeURIComponent(room)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('讀取預約失敗');
  const data = await res.json();
  return data.map || {};
}
async function postBooking(booking){
  if (!isGAS){
    const s = loadFromLS(); const k = bookingKey(booking.date, booking.room, booking.hour);
    if (s[k]) throw new Error('該時段已被預約');
    s[k] = booking; saveToLS(s); return {ok:true};
  }
  const res = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:'book', ...booking }) });
  const data = await res.json();
  if (!res.ok || !data.ok) throw new Error(data.message || '預約失敗');
  return data;
}
async function postCancel(payload){
  if (!isGAS){
    const s = loadFromLS(); const k = bookingKey(payload.date,payload.room,payload.hour);
    const b = s[k]; if (!b) throw new Error('查無該時段預約');
    if (String(b.sid)!==String(payload.sid) || String(b.phone)!==String(payload.phone)) throw new Error('學號或電話不符，無法取消');
    delete s[k]; saveToLS(s); return {ok:true};
  }
  const res = await fetch(GAS_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ action:'cancel', ...payload }) });
  const data = await res.json();
  if (!res.ok || !data.ok) throw new Error(data.message || '取消失敗');
  return data;
}

/** ===== UI 元件 ===== */
const dateInput = $('#dateInput');
const roomSelect = $('#roomSelect');
const loadBtn = $('#loadBtn');
const slotsWrap = $('#slotsWrap');
const slotsGrid = $('#slotsGrid');
const slotsTitle = $('#slotsTitle');

const formPanel = $('#formPanel');
const formTitle = $('#formTitle');
const formBody = $('#formBody');
const formMsg = $('#formMsg');

dateInput.value = todayISO();
dateInput.min = todayISO();
$('#dateHint').textContent = '請選「平日」日期再按「載入時段」';

/** ===== 診斷 ===== */
function setDiag(){
  $('#diag').innerHTML = `診斷：GAS_BASE = <code>${GAS_BASE}</code> ｜ 模式：<b>${isGAS?'連線到 Apps Script':'本機儲存'}</b>`;
}
setDiag();

/** ===== 行為 ===== */
loadBtn.addEventListener('click', async ()=>{
  const date = dateInput.value;
  if (!date){ alert('請先選擇日期'); return; }
  if (!isWeekday(date)){ alert('僅能預約週一至週五'); return; }
  const room = roomSelect.value;
  await renderSlots(date, room);
});

async function renderSlots(date, room){
  const store = await fetchBookings(date, room);
  slotsGrid.innerHTML = '';
  slotsTitle.textContent = `${date}｜${room}`;
  for (const h of HOURS){
    const key = bookingKey(date, room, h);
    const booked = !!store[key];
    const el = document.createElement('button');
    el.className = 'slot' + (booked?' booked':'');
    el.textContent = `${pad2(h)}:00–${pad2(h+1)}:00` + (booked?'（已預約）':'');
    el.addEventListener('click', ()=>{
      if (booked) openCancelForm({date, room, hour:h});
      else openBookingForm({date, room, hour:h});
    });
    slotsGrid.appendChild(el);
  }
  slotsWrap.style.display = 'block';
  formPanel.style.display = 'none';
}

/** ===== 表單：預約 ===== */
function openBookingForm({date, room, hour}){
  formTitle.textContent = '預約表單';
  formBody.innerHTML = `
    <div class="hint">時段：${date}｜${room}｜${pad2(hour)}:00–${pad2(hour+1)}:00</div>
    <div style="margin-top:8px">
      <label>姓名</label>
      <input id="nameInput" style="width:100%">
    </div>
    <div style="margin-top:8px">
      <label>學號</label>
      <input id="sidInput" style="width:100%">
    </div>
    <div style="margin-top:8px">
      <label>電話</label>
      <input id="phoneInput" style="width:100%">
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="secondary" type="button" id="cancelBtn">取消</button>
      <button type="button" id="submitBtn">送出預約</button>
    </div>
  `;
  formMsg.textContent = '';
  formPanel.style.display = 'block';
  $('#cancelBtn').onclick = ()=>{ formPanel.style.display='none'; };
  $('#submitBtn').onclick = async ()=>{
    const name = String($('#nameInput').value||'').trim();
    const sid = String($('#sidInput').value||'').trim();
    const phone = String($('#phoneInput').value||'').trim();
    if (!name || !sid || !phone){ formMsg.innerHTML = '<span class="err">請完整填寫</span>'; return; }
    const booking = { date, room, hour, name, sid, phone, createdAt:new Date().toISOString() };
    try{
      // 避免剛好被別人搶
      const store = await fetchBookings(date, room);
      if (store[bookingKey(date,room,hour)]){ formMsg.innerHTML='<span class="err">該時段剛被預約，請換一個</span>'; await renderSlots(date, room); return; }
      await postBooking(booking);
      formMsg.innerHTML = '<span class="ok">預約成功！</span>';
      setTimeout(()=>{ formPanel.style.display='none'; renderSlots(date, room); }, 600);
    }catch(e){
      formMsg.innerHTML = '<span class="err">'+ (e?.message || '預約失敗') +'</span>';
    }
  };
}

/** ===== 表單：取消 ===== */
function openCancelForm({date, room, hour}){
  formTitle.textContent = '取消表單';
  formBody.innerHTML = `
    <div class="hint">時段：${date}｜${room}｜${pad2(hour)}:00–${pad2(hour+1)}:00</div>
    <div style="margin-top:8px">
      <label>學號（驗證）</label>
      <input id="sidC" style="width:100%">
    </div>
    <div style="margin-top:8px">
      <label>電話（驗證）</label>
      <input id="phoneC" style="width:100%">
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="secondary" type="button" id="backBtn">返回</button>
      <button type="button" id="confirmBtn" style="background:#dc2626;border-color:#dc2626">確認取消</button>
    </div>
  `;
  formMsg.textContent = '';
  formPanel.style.display = 'block';
  $('#backBtn').onclick = ()=>{ formPanel.style.display='none'; };
  $('#confirmBtn').onclick = async ()=>{
    const sid = String($('#sidC').value||'').trim();
    const phone = String($('#phoneC').value||'').trim();
    if (!sid || !phone){ formMsg.innerHTML='<span class="err">請輸入學號與電話</span>'; return; }
    const payload = { date, room, hour, sid, phone };
    try{
      await postCancel(payload);
      formMsg.innerHTML = '<span class="ok">已取消該時段預約</span>';
      setTimeout(()=>{ formPanel.style.display='none'; renderSlots(date, room); }, 600);
    }catch(e){
      formMsg.innerHTML = '<span class="err">'+ (e?.message || '取消失敗') +'</span>';
    }
  };
}
</script>
</body>
</html>
